<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV Importer</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;padding:24px;background:#f6f8fa;color:#111}
    .container{max-width:1000px;margin:0 auto}
    header{margin-bottom:18px}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 16px;color:#555}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .btn{padding:8px 12px;border:1px solid #cbd5e1;background:#fff;color:#111;border-radius:6px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    #drop-area{border:2px dashed #cbd5e1;border-radius:8px;padding:18px;text-align:center;background:#fff}
    #drop-area.dragover{background:#eef2ff;border-color:#7c3aed}
    #preview{margin-top:14px;background:#fff;border-radius:8px;padding:12px;overflow:auto;border:1px solid #e6e9ef}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eef0f3;text-align:left}
    th{background:#fbfdff;position:sticky;top:0}
    #log{width:100%;height:110px;margin-top:12px;padding:8px;border-radius:6px;border:1px solid #e6e9ef;background:#fff;resize:vertical;font-family:monospace;font-size:13px}
    .meta{margin-top:8px;color:#555;font-size:13px}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>CSV Importer</h1>
      <p class="lead">Upload or drag & drop a CSV file to preview and import data. Supports quoted fields and newlines inside fields.</p>
    </header>

    <section>
      <div class="controls">
        <label class="btn" for="file-input">Choose CSV</label>
        <input id="file-input" type="file" accept=".csv,text/csv" style="display:none" />

        <button id="clear-btn" class="btn" type="button" disabled>Clear</button>
        <button id="import-btn" class="btn" type="button" disabled>Import</button>

        <select id="delimiter" class="btn" title="Field delimiter">
          <option value=",">Comma (,)</option>
          <option value=";">Semicolon (;)</option>
          <option value="\t">Tab</option>
        </select>

        <button id="download-sample" class="btn" type="button">Download Sample</button>
      </div>

      <div id="drop-area" aria-label="CSV drop area" tabindex="0">
        Drop CSV file here or click "Choose CSV"
        <div class="meta small">Max preview rows: 100. Large files are supported; full data retained in memory for import.</div>
      </div>

      <div id="preview" aria-live="polite" role="region">
        <div class="small">No file loaded.</div>
      </div>

      <textarea id="log" readonly placeholder="Import log appears here..."></textarea>
    </section>
  </div>

  <script>
    (function () {
      const fileInput = document.getElementById('file-input');
      const dropArea = document.getElementById('drop-area');
      const preview = document.getElementById('preview');
      const importBtn = document.getElementById('import-btn');
      const clearBtn = document.getElementById('clear-btn');
      const logEl = document.getElementById('log');
      const delimiterSelect = document.getElementById('delimiter');
      const downloadSampleBtn = document.getElementById('download-sample');

      let csvData = null; // array of rows (each row is array of cells)
      let filename = '';

      function parseCSV(text, delimiter=',') {
        const rows = [];
        let cur = '';
        let row = [];
        let i = 0;
        let inQuotes = false;
        while (i < text.length) {
          const ch = text[i];
          if (ch === '"') {
            if (inQuotes && text[i+1] === '"') {
              cur += '"';
              i += 2;
              continue;
            }
            inQuotes = !inQuotes;
            i++;
            continue;
          }
          if (!inQuotes && ch === delimiter) {
            row.push(cur);
            cur = '';
            i++;
            continue;
          }
          if (!inQuotes && (ch === '\r' || ch === '\n')) {
            // handle CRLF or LF
            row.push(cur);
            cur = '';
            rows.push(row);
            row = [];
            if (ch === '\r' && text[i+1] === '\n') i += 2; else i++;
            continue;
          }
          cur += ch;
          i++;
        }
        // push last cell
        if (inQuotes) {
          // unmatched quotes - still push what we have
        }
        if (cur !== '' || row.length > 0) {
          row.push(cur);
          rows.push(row);
        }
        return rows;
      }

      function renderPreview(rows) {
        preview.innerHTML = '';
        if (!rows || rows.length === 0) {
          preview.textContent = 'No data to preview.';
          return;
        }
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        const headerRow = document.createElement('tr');
        const header = rows[0];
        header.forEach(cell => {
          const th = document.createElement('th');
          th.textContent = cell || '';
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        // preview up to 100 rows beyond header
        const maxPreview = 100;
        for (let r = 1; r < rows.length && r <= maxPreview; r++) {
          const tr = document.createElement('tr');
          const row = rows[r];
          for (let c = 0; c < header.length; c++) {
            const td = document.createElement('td');
            td.textContent = row[c] ?? '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(thead);
        table.appendChild(tbody);
        preview.appendChild(table);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `Rows: ${rows.length} (showing up to ${maxPreview} rows). Columns: ${header.length}. File: ${filename}`;
        preview.appendChild(meta);
      }

      function handleText(text) {
        const delim = delimiterSelect.value === "\\t" ? "\t" : delimiterSelect.value;
        csvData = parseCSV(text, delim);
        renderPreview(csvData);
        importBtn.disabled = !csvData || csvData.length < 2;
        clearBtn.disabled = false;
        log(`Loaded ${csvData.length} rows.`);
      }

      function handleFile(file) {
        filename = file.name;
        const reader = new FileReader();
        reader.onload = () => handleText(reader.result);
        reader.onerror = () => log('Failed to read file.');
        reader.readAsText(file, 'utf-8');
      }

      // Drag & drop
      ['dragenter','dragover'].forEach(ev => {
        dropArea.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          dropArea.classList.add('dragover');
        });
      });
      ['dragleave','drop'].forEach(ev => {
        dropArea.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          dropArea.classList.remove('dragover');
        });
      });
      dropArea.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        if (!dt) return;
        const file = dt.files && dt.files[0];
        if (file) handleFile(file);
      });

      // File input
      fileInput.addEventListener('change', e => {
        const f = fileInput.files && fileInput.files[0];
        if (f) handleFile(f);
      });

      dropArea.addEventListener('click', () => fileInput.click());
      dropArea.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') fileInput.click(); });

      importBtn.addEventListener('click', async () => {
        if (!csvData || csvData.length < 2) {
          log('No data to import.');
          return;
        }
        importBtn.disabled = true;
        clearBtn.disabled = true;
        log(`Starting import of ${csvData.length - 1} records...`);
        // Simulate import with batched processing
        const header = csvData[0];
        const batchSize = 200;
        for (let i = 1; i < csvData.length; i += batchSize) {
          const batch = csvData.slice(i, i + batchSize);
          // Here you would send batch to server. This simulates a delay.
          await new Promise(res => setTimeout(res, 250));
          log(`Imported rows ${i}â€“${Math.min(i + batchSize - 1, csvData.length - 1)} (${batch.length} records).`);
        }
        log('Import complete.');
        importBtn.disabled = false;
        clearBtn.disabled = false;
      });

      clearBtn.addEventListener('click', () => {
        csvData = null;
        filename = '';
        preview.innerHTML = '<div class="small">No file loaded.</div>';
        log('Cleared.');
        importBtn.disabled = true;
        clearBtn.disabled = true;
        fileInput.value = '';
      });

      delimiterSelect.addEventListener('change', () => {
        if (fileInput.files && fileInput.files[0]) handleFile(fileInput.files[0]);
      });

      downloadSampleBtn.addEventListener('click', () => {
        const sample = [
          ['id','name','email','notes'],
          ['1','Alice','alice@example.com','Line1\nLine2'],
          ['2','Bob','bob@example.com','"Quoted, field"'],
        ];
        const csv = sample.map(r => r.map(cell => {
          if (cell == null) return '';
          const s = String(cell);
          if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
            return '"' + s.replace(/"/g,'""') + '"';
          }
          return s;
        }).join(',')).join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sample.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      function log(msg) {
        const ts = new Date().toISOString();
        logEl.value = `[${ts}] ${msg}\n` + logEl.value;
      }

      // initial state
      importBtn.disabled = true;
      clearBtn.disabled = true;
    })();
  </script>
</body>
</html>